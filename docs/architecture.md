# XiaoZhi Flow ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ğŸ“– æ¦‚è¿°

XiaoZhi Flow æ˜¯ä¸€ä¸ªä¼ä¸šçº§è¯­éŸ³äº¤äº’æœºå™¨äººå¹³å°ï¼ŒåŸºäº Go è¯­è¨€å¼€å‘ï¼Œé‡‡ç”¨å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œç»“åˆå¤šç§ AI æ¨¡å‹ï¼Œé€šè¿‡ MCP (Model Context Protocol) åè®®è¿æ¥å¤šç«¯è®¾å¤‡ï¼Œå®ç°é«˜æ•ˆè‡ªç„¶çš„äººæœºå¯¹è¯ä½“éªŒã€‚

### æ ¸å¿ƒç‰¹æ€§

- **ğŸ¯ æ™ºèƒ½è¯­éŸ³äº¤äº’** - é›†æˆ ASRã€TTSã€LLM ç­‰å¤šç§ AI æœåŠ¡
- **ğŸ”Œ æ’ä»¶åŒ–æ¶æ„** - æ”¯æŒçƒ­æ’æ‹”çš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ
- **ğŸŒ å¤šç«¯æ”¯æŒ** - Webã€ç§»åŠ¨ç«¯ã€ESP32 è®¾å¤‡ç­‰å¤šå¹³å°æ¥å…¥
- **ğŸ›¡ï¸ ä¼ä¸šçº§å®‰å…¨** - å¤šå±‚å®‰å…¨æœºåˆ¶å’Œæ²™ç®±éš”ç¦»
- **ğŸ“Š å¯è§‚æµ‹æ€§** - å®Œæ•´çš„ç›‘æ§ã€æ—¥å¿—ã€è¿½è¸ªä½“ç³»
- **ğŸš€ äº‘åŸç”Ÿéƒ¨ç½²** - æ”¯æŒ Docker å’Œ Kubernetes éƒ¨ç½²

---

## ğŸ—ï¸ æ•´ä½“ç³»ç»Ÿæ¶æ„

### æ¶æ„åˆ†å±‚

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚ (Frontend Layer)"
        A[React Web App] --> B[Ant Design UI]
        A --> C[React Flowæµç¨‹ç¼–è¾‘å™¨]
        A --> D[ZustandçŠ¶æ€ç®¡ç†]
        A --> E[Axios HTTPå®¢æˆ·ç«¯]
    end

    subgraph "ç½‘å…³å±‚ (Gateway Layer)"
        F[Gateway API Server<br/>:8090] --> G[ç»Ÿä¸€ç½‘å…³è·¯ç”±]
        F --> H[è´Ÿè½½å‡è¡¡å™¨]
        F --> I[æ’ä»¶ä»£ç†]
    end

    subgraph "ä¼ è¾“å±‚ (Transport Layer)"
        J[HTTP Server<br/>:8080] --> K[RESTful API]
        J --> L[é™æ€æ–‡ä»¶æœåŠ¡]
        J --> M[OpenAPIæ–‡æ¡£]

        N[WebSocket Server] --> O[å®æ—¶é€šä¿¡]
        N --> P[ä¼šè¯ç®¡ç†]
        N --> Q[æ¶ˆæ¯å¹¿æ’­]
    end

    subgraph "ä¸šåŠ¡é€»è¾‘å±‚ (Domain Layer)"
        R[è®¤è¯ç®¡ç†å™¨<br/>AuthManager] --> S[å®¢æˆ·ç«¯è®¤è¯]
        R --> T[ä¼šè¯ç®¡ç†]

        U[MCPç®¡ç†å™¨<br/>MCPManager] --> V[æœ¬åœ°å·¥å…·]
        U --> W[AIæ¨¡å‹é›†æˆ]
        U --> X[å¤–éƒ¨å·¥å…·è°ƒç”¨]

        Y[æ’ä»¶ç®¡ç†å™¨<br/>PluginManager] --> Z[æ’ä»¶å‘ç°]
        Y --> AA[æ’ä»¶ç”Ÿå‘½å‘¨æœŸ]
        Y --> BB[å¥åº·æ£€æŸ¥]

        CC[è®¾å¤‡ç®¡ç†å™¨<br/>DeviceManager] --> DD[è®¾å¤‡æ³¨å†Œ]
        CC --> EE[OTAæ›´æ–°]
        CC --> FF[çŠ¶æ€ç›‘æ§]
    end

    subgraph "æ’ä»¶ç³»ç»Ÿ (Plugin System)"
        GG[ç»Ÿä¸€æ’ä»¶ç½‘å…³] --> HH[LLMæ’ä»¶]
        GG --> II[ASRæ’ä»¶]
        GG --> JJ[TTSæ’ä»¶]
        GG --> KK[è®¾å¤‡æ’ä»¶]
        GG --> LL[å·¥å…·æ’ä»¶]
    end

    subgraph "åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)"
        MM[é…ç½®ç®¡ç†] --> NN[æ•°æ®åº“é…ç½®]
        MM --> OO[è¿è¡Œæ—¶é…ç½®]

        PP[å­˜å‚¨å±‚] --> QQ[SQLiteæ•°æ®åº“]
        PP --> RR[æ–‡ä»¶å­˜å‚¨]
        PP --> SS[ç¼“å­˜å­˜å‚¨]

        TT[æ—¥å¿—ç³»ç»Ÿ] --> UU[ç»“æ„åŒ–æ—¥å¿—]
        TT --> VV[äº‹ä»¶è®°å½•]

        WW[å¯è§‚æµ‹æ€§] --> XX[æŒ‡æ ‡æ”¶é›†]
        WW --> YY[åˆ†å¸ƒå¼è¿½è¸ª]
    end

    A --> J
    A --> N
    F --> J
    F --> N
    J --> R
    J --> U
    J --> Y
    J --> CC
    N --> U
    Y --> GG
    U --> GG
    R --> MM
    U --> MM
    Y --> MM
    CC --> MM
    R --> PP
    U --> PP
    Y --> PP
    CC --> PP
    MM --> TT
    TT --> WW
```

### æŠ€æœ¯æ ˆæ¦‚è§ˆ

#### åç«¯æŠ€æœ¯æ ˆ
- **Go 1.24.0** - ä¸»è¦å¼€å‘è¯­è¨€
- **Gin** - Webæ¡†æ¶
- **GORM** - ORMæ¡†æ¶
- **WebSocket** - å®æ—¶é€šä¿¡
- **HashiCorp Go-Plugin** - æ’ä»¶æ¡†æ¶
- **SQLite/MySQL/PostgreSQL** - æ•°æ®åº“æ”¯æŒ
- **Redis** - ç¼“å­˜å­˜å‚¨
- **JWT** - èº«ä»½éªŒè¯
- **Docker** - å®¹å™¨åŒ–éƒ¨ç½²

#### å‰ç«¯æŠ€æœ¯æ ˆ
- **React 19.2.0** - å‰ç«¯æ¡†æ¶
- **TypeScript** - ç±»å‹å®‰å…¨
- **Ant Design 6.0** - UIç»„ä»¶åº“
- **React Flow** - æµç¨‹å›¾ç¼–è¾‘å™¨
- **Zustand** - çŠ¶æ€ç®¡ç†
- **Axios** - HTTPå®¢æˆ·ç«¯
- **Three.js** - 3Dæ¸²æŸ“
- **TanStack Query** - æ•°æ®è·å–

---

## ğŸš€ ç³»ç»Ÿå¯åŠ¨åŠ è½½æµç¨‹

### åˆå§‹åŒ–æ­¥éª¤

ç³»ç»Ÿé‡‡ç”¨**æœ‰å‘æ— ç¯å›¾(DAG)å¼çš„åˆå§‹åŒ–æµç¨‹**ï¼Œé€šè¿‡ `InitGraph()` å‡½æ•°å®šä¹‰äº† 11 ä¸ªæœ‰åºçš„åˆå§‹åŒ–æ­¥éª¤ï¼š

```mermaid
flowchart TD
    A[å¼€å§‹å¯åŠ¨] --> B[å­˜å‚¨åˆå§‹åŒ–]
    B --> C[é…ç½®å­˜å‚¨åˆå§‹åŒ–]
    C --> D[æ•°æ®åº“åˆå§‹åŒ–]
    D --> E[åŠ è½½é»˜è®¤é…ç½®]
    E --> F[æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–]
    F --> G[MCPç®¡ç†å™¨åˆå§‹åŒ–]
    G --> H[å¯è§‚æµ‹æ€§è®¾ç½®]
    H --> I[ç»„ä»¶å®¹å™¨åˆå§‹åŒ–]
    I --> J[é…ç½®é›†æˆå™¨åˆå§‹åŒ–]
    J --> K[è®¤è¯ç®¡ç†å™¨åˆå§‹åŒ–]
    K --> L[æ’ä»¶ç®¡ç†å™¨åˆå§‹åŒ–]

    L --> M[å¯åŠ¨ä¼ è¾“æœåŠ¡]
    M --> N[å¯åŠ¨HTTPæœåŠ¡]
    N --> O[æ³¨å†ŒAPIè·¯ç”±]
    O --> P[è®¾ç½®é™æ€æ–‡ä»¶æœåŠ¡]
    P --> Q[å¯åŠ¨WebSocketæœåŠ¡]

    Q --> R[å¯åŠ¨æ’ä»¶æœåŠ¡]
    R --> S[æ‰«ææ’ä»¶ç›®å½•]
    S --> T[åŠ è½½æ’ä»¶é…ç½®]
    T --> U[å¯åŠ¨æ’ä»¶è¿›ç¨‹]
    U --> V[æ³¨å†Œæ’ä»¶æœåŠ¡]

    V --> W[å¯åŠ¨ç½‘å…³æœåŠ¡]
    W --> X[è®¾ç½®è·¯ç”±è§„åˆ™]
    X --> Y[é…ç½®è´Ÿè½½å‡è¡¡]
    Y --> Z[å¯åŠ¨APIæœåŠ¡å™¨]

    Z --> AA[ç³»ç»Ÿå°±ç»ª]
    AA --> BB[ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥]

    style A fill:#e1f5fe
    style AA fill:#c8e6c9
    style BB fill:#fff3e0
```

### è¯¦ç»†å¯åŠ¨åºåˆ—

```mermaid
sequenceDiagram
    participant Main as ä¸»ç¨‹åºå…¥å£
    participant Bootstrap as å¼•å¯¼ç¨‹åº
    participant Storage as å­˜å‚¨å±‚
    participant Config as é…ç½®ç®¡ç†
    participant Logging as æ—¥å¿—ç³»ç»Ÿ
    participant Auth as è®¤è¯ç®¡ç†
    participant MCP as MCPç®¡ç†å™¨
    participant Plugin as æ’ä»¶ç®¡ç†å™¨
    participant Transport as ä¼ è¾“å±‚
    participant Gateway as ç½‘å…³æœåŠ¡

    Main->>Bootstrap: 1. å¯åŠ¨å¼•å¯¼ç¨‹åº
    Bootstrap->>Storage: 2. åˆå§‹åŒ–é…ç½®å­˜å‚¨
    Storage-->>Bootstrap: å­˜å‚¨å°±ç»ª

    Bootstrap->>Storage: 3. åˆå§‹åŒ–æ•°æ®åº“
    Storage-->>Bootstrap: æ•°æ®åº“è¿æ¥æˆåŠŸ

    Bootstrap->>Config: 4. åŠ è½½é»˜è®¤é…ç½®
    Config-->>Bootstrap: é…ç½®åŠ è½½å®Œæˆ

    Bootstrap->>Logging: 5. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
    Logging-->>Bootstrap: æ—¥å¿—ç³»ç»Ÿå°±ç»ª

    Bootstrap->>MCP: 6. åˆå§‹åŒ–MCPç®¡ç†å™¨
    MCP-->>Bootstrap: MCPç®¡ç†å™¨å°±ç»ª

    Bootstrap->>Auth: 7. åˆå§‹åŒ–è®¤è¯ç®¡ç†å™¨
    Auth-->>Bootstrap: è®¤è¯ç®¡ç†å™¨å°±ç»ª

    Bootstrap->>Plugin: 8. åˆå§‹åŒ–æ’ä»¶ç®¡ç†å™¨
    Plugin->>Plugin: æ‰«ææ’ä»¶ç›®å½•
    Plugin->>Plugin: åŠ è½½æ’ä»¶é…ç½®
    Plugin-->>Bootstrap: æ’ä»¶ç³»ç»Ÿå°±ç»ª

    Bootstrap->>Transport: 9. å¯åŠ¨ä¼ è¾“å±‚æœåŠ¡
    par å¹¶è¡Œå¯åŠ¨HTTPå’ŒWebSocketæœåŠ¡
        Transport->>Transport: å¯åŠ¨HTTPæœåŠ¡å™¨
        Transport->>Transport: å¯åŠ¨WebSocketæœåŠ¡å™¨
    end
    Transport-->>Bootstrap: ä¼ è¾“å±‚å°±ç»ª

    Bootstrap->>Gateway: 10. å¯åŠ¨ç½‘å…³æœåŠ¡
    Gateway-->>Bootstrap: ç½‘å…³æœåŠ¡å°±ç»ª

    Bootstrap-->>Main: ç³»ç»Ÿå¯åŠ¨å®Œæˆ

    Note over Main, Gateway: ç³»ç»Ÿè¿›å…¥è¿è¡ŒçŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
```

---

## ğŸŒ å‰ç«¯åº”ç”¨æ¶æ„

### å‰ç«¯ç›®å½•ç»“æ„

```
web/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/           # Reactç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ErrorBoundary/   # é”™è¯¯è¾¹ç•Œ
â”‚   â”‚   â”œâ”€â”€ QueryProvider/   # æ•°æ®æŸ¥è¯¢æä¾›è€…
â”‚   â”‚   â”œâ”€â”€ SystemInitializer/ # ç³»ç»Ÿåˆå§‹åŒ–
â”‚   â”‚   â””â”€â”€ ProtectedRoute/  # è·¯ç”±ä¿æŠ¤
â”‚   â”œâ”€â”€ pages/               # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Dashboard/       # ä¸»é¢æ¿
â”‚   â”‚   â”œâ”€â”€ Login/          # ç™»å½•é¡µé¢
â”‚   â”‚   â”œâ”€â”€ Register/       # æ³¨å†Œé¡µé¢
â”‚   â”‚   â”œâ”€â”€ Setup/          # è®¾ç½®é¡µé¢
â”‚   â”‚   â””â”€â”€ Config/         # é…ç½®é¡µé¢
â”‚   â”œâ”€â”€ contexts/           # React Context
â”‚   â”œâ”€â”€ hooks/              # è‡ªå®šä¹‰hooks
â”‚   â”œâ”€â”€ stores/             # ZustandçŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ nodes/              # èŠ‚ç‚¹ç»„ä»¶
â”‚   â”œâ”€â”€ plugins/            # å‰ç«¯æ’ä»¶
â”‚   â”œâ”€â”€ services/           # APIæœåŠ¡
â”‚   â””â”€â”€ types/              # TypeScriptç±»å‹
â”œâ”€â”€ package.json
â””â”€â”€ dist/                   # æ„å»ºè¾“å‡º
```

### å‰ç«¯åº”ç”¨çŠ¶æ€

```mermaid
stateDiagram-v2
    [*] --> Appåˆå§‹åŒ–
    Appåˆå§‹åŒ– --> é”™è¯¯è¾¹ç•Œè®¾ç½®
    é”™è¯¯è¾¹ç•Œè®¾ç½® --> QueryProvideré…ç½®
    QueryProvideré…ç½® --> AuthProvideré…ç½®
    AuthProvideré…ç½® --> è·¯ç”±ç³»ç»Ÿåˆå§‹åŒ–
    è·¯ç”±ç³»ç»Ÿåˆå§‹åŒ– --> ç³»ç»Ÿåˆå§‹åŒ–æ£€æŸ¥
    ç³»ç»Ÿåˆå§‹åŒ–æ£€æŸ¥ --> æ™ºèƒ½è·¯ç”±åˆ¤æ–­

    æ™ºèƒ½è·¯ç”±åˆ¤æ–­ --> æœªè®¤è¯: éœ€è¦ç™»å½•
    æ™ºèƒ½è·¯ç”±åˆ¤æ–­ --> å·²è®¤è¯: æ— éœ€ç™»å½•
    æ™ºèƒ½è·¯ç”±åˆ¤æ–­ --> ç³»ç»Ÿæœªé…ç½®: éœ€è¦è®¾ç½®

    æœªè®¤è¯ --> ç™»å½•é¡µé¢
    å·²è®¤è¯ --> ä¸»é¢æ¿
    ç³»ç»Ÿæœªé…ç½® --> è®¾ç½®é¡µé¢

    ç™»å½•é¡µé¢ --> è®¤è¯æˆåŠŸ
    è®¤è¯æˆåŠŸ --> ä¸»é¢æ¿
    è®¾ç½®é¡µé¢ --> é…ç½®å®Œæˆ
    é…ç½®å®Œæˆ --> ä¸»é¢æ¿

    ä¸»é¢æ¿ --> åŠŸèƒ½æ¨¡å—:
        åŠŸèƒ½æ¨¡å— --> æµç¨‹ç¼–è¾‘å™¨
        åŠŸèƒ½æ¨¡å— --> é…ç½®ç®¡ç†
        åŠŸèƒ½æ¨¡å— --> è®¾å¤‡ç®¡ç†

    æµç¨‹ç¼–è¾‘å™¨ --> è¿è¡ŒçŠ¶æ€
    é…ç½®ç®¡ç† --> è¿è¡ŒçŠ¶æ€
    è®¾å¤‡ç®¡ç† --> è¿è¡ŒçŠ¶æ€
    è¿è¡ŒçŠ¶æ€ --> [*]
```

### å‰ç«¯æ ¸å¿ƒç‰¹æ€§

1. **æ™ºèƒ½è·¯ç”±ç³»ç»Ÿ** - æ ¹æ®è®¤è¯çŠ¶æ€å’Œç³»ç»Ÿé…ç½®è‡ªåŠ¨å¯¼èˆª
2. **é”™è¯¯è¾¹ç•Œä¿æŠ¤** - å…¨å±€é”™è¯¯æ•è·å’Œå¤„ç†
3. **çŠ¶æ€ç®¡ç†** - Zustand + React Query åŒé‡çŠ¶æ€ç®¡ç†
4. **ç»„ä»¶åŒ–è®¾è®¡** - é«˜åº¦æ¨¡å—åŒ–çš„ç»„ä»¶æ¶æ„
5. **ç±»å‹å®‰å…¨** - å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
6. **å“åº”å¼å¸ƒå±€** - æ”¯æŒå¤šè®¾å¤‡å°ºå¯¸é€‚é…

---

## ğŸ”§ åç«¯æœåŠ¡æ¶æ„

### æ ¸å¿ƒæœåŠ¡æ¨¡å—

#### 1. ä¼ è¾“å±‚æœåŠ¡

**HTTPæœåŠ¡** (`:8080`)
- RESTful APIæ¥å£
- é™æ€æ–‡ä»¶æœåŠ¡
- OpenAPIæ–‡æ¡£ç”Ÿæˆ
- SPAè·¯ç”±æ”¯æŒ

**WebSocketæœåŠ¡**
- å®æ—¶åŒå‘é€šä¿¡
- ä¼šè¯ç®¡ç†
- æ¶ˆæ¯å¹¿æ’­
- è¿æ¥æ± ç®¡ç†

#### 2. ä¸šåŠ¡é€»è¾‘å±‚

**è®¤è¯ç®¡ç†å™¨ (AuthManager)**
- å®¢æˆ·ç«¯æ³¨å†Œå’Œè®¤è¯
- ä¼šè¯ç®¡ç†å’ŒTTLæ§åˆ¶
- å¤šç§å­˜å‚¨åç«¯æ”¯æŒï¼ˆå†…å­˜/SQLite/Redisï¼‰
- å¯†é’¥ç”Ÿæˆå’ŒéªŒè¯

**MCPç®¡ç†å™¨ (MCPManager)**
- æœ¬åœ°å·¥å…·ç®¡ç†
- XiaoZhiå®¢æˆ·ç«¯é›†æˆ
- å¤–éƒ¨å·¥å…·åŠ¨æ€æ³¨å†Œ
- å·¥å…·è°ƒç”¨ç¼“å­˜ï¼ˆç²¾ç¡®ç¼“å­˜+æ™ºèƒ½ç¼“å­˜ï¼‰

**è®¾å¤‡ç®¡ç†å™¨ (DeviceManager)**
- è®¾å¤‡æ³¨å†Œå’Œç®¡ç†
- OTAå›ºä»¶æ›´æ–°
- è®¾å¤‡çŠ¶æ€ç›‘æ§
- éªŒè¯ç ç®¡ç†

#### 3. æ’ä»¶ç®¡ç†å™¨ (PluginManager)
- æ’ä»¶åŠ¨æ€å‘ç°å’ŒåŠ è½½
- ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å¥åº·æ£€æŸ¥å’Œç›‘æ§
- æ²™ç®±éš”ç¦»å’Œæƒé™æ§åˆ¶

### æ•°æ®å­˜å‚¨æ¶æ„

#### é€‚é…å™¨æ¨¡å¼è®¾è®¡
```go
type DatabaseAdapter interface {
    GetDB() *gorm.DB
    Close() error
    Migrate() error
}

type SQLiteAdapter struct {
    db *gorm.DB
}
```

#### æ•°æ®åº“ç‰¹æ€§
- **WALæ¨¡å¼** - æé«˜å¹¶å‘æ€§èƒ½
- **è¿æ¥æ± ä¼˜åŒ–** - é’ˆå¯¹SQLiteä¼˜åŒ–
- **è‡ªåŠ¨è¿ç§»** - GORM AutoMigrate
- **å¤šæ•°æ®åº“æ”¯æŒ** - SQLite/MySQL/PostgreSQL

#### æ•°æ®å®ä½“
- `users` - ç”¨æˆ·ç®¡ç†
- `devices` - è®¾å¤‡ç®¡ç†
- `auth_clients` - è®¤è¯å®¢æˆ·ç«¯
- `config_records` - é…ç½®è®°å½•
- `domain_events` - äº‹ä»¶è®°å½•

### è®¤è¯æˆæƒæœºåˆ¶

#### å¤šå±‚è®¤è¯æ¶æ„
1. **å®¢æˆ·ç«¯è®¤è¯** - ClientID + Username + Password
2. **ä¼šè¯ç®¡ç†** - åŸºäºTTLçš„ä¼šè¯æœºåˆ¶
3. **å¯†é’¥ç®¡ç†** - æ”¯æŒä¼šè¯å¯†é’¥ç”Ÿæˆ
4. **å­˜å‚¨åç«¯** - å†…å­˜/SQLite/Redis

#### è®¤è¯æµç¨‹
```go
func (am *AuthManager) Authenticate(ctx context.Context, clientID, username, password string) (*ClientInfo, bool, error)
```

### APIè®¾è®¡

#### ç»Ÿä¸€å“åº”æ ¼å¼
```json
{
  "success": true,
  "data": {},
  "message": "æ“ä½œæˆåŠŸ",
  "code": 200
}
```

#### ä¸­é—´ä»¶æ ˆ
- **CORSä¸­é—´ä»¶** - è·¨åŸŸè¯·æ±‚å¤„ç†
- **æ—¥å¿—ä¸­é—´ä»¶** - HTTPè¯·æ±‚æ—¥å¿—è®°å½•
- **å¯è§‚æµ‹æ€§ä¸­é—´ä»¶** - åˆ†å¸ƒå¼è¿½è¸ªå’ŒæŒ‡æ ‡æ”¶é›†
- **æ¢å¤ä¸­é—´ä»¶** - panicæ¢å¤

---

## ğŸ”Œ æ’ä»¶ç³»ç»Ÿæ¶æ„

### æ’ä»¶ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚ (Application Layer)"
        A[åº”ç”¨ç¨‹åº]
    end

    subgraph "æ’ä»¶ç®¡ç†å±‚ (Plugin Management Layer)"
        B[æ’ä»¶ç®¡ç†å™¨]
        C[ç»Ÿä¸€ç½‘å…³]
    end

    subgraph "æ’ä»¶æœåŠ¡å±‚ (Plugin Service Layer)"
        D[æ’ä»¶å‘ç°æœåŠ¡]
        E[æ’ä»¶æ³¨å†Œè¡¨]
        F[è¿è¡Œæ—¶ç®¡ç†å™¨]
        G[å¥åº·æ£€æŸ¥æœåŠ¡]
    end

    subgraph "æ’ä»¶SDKå±‚ (Plugin SDK Layer)"
        H[æ’ä»¶åŸºç¡€æ¥å£]
        I[éŸ³é¢‘æ’ä»¶æ¥å£]
        J[LLMæ’ä»¶æ¥å£]
        K[è®¾å¤‡æ’ä»¶æ¥å£]
    end

    subgraph "æ’ä»¶è¿è¡Œæ—¶ (Plugin Runtime)"
        L[æœ¬åœ°äºŒè¿›åˆ¶è¿è¡Œæ—¶]
        M[Dockerå®¹å™¨è¿è¡Œæ—¶]
        N[è¿œç¨‹æœåŠ¡è¿è¡Œæ—¶]
    end

    subgraph "æ’ä»¶å®ä¾‹ (Plugin Instances)"
        O[LLMæ’ä»¶]
        P[ASRæ’ä»¶]
        Q[TTSæ’ä»¶]
        R[è®¾å¤‡æ’ä»¶]
        S[å·¥å…·æ’ä»¶]
    end

    A --> B
    B --> C
    B --> D
    B --> E
    B --> F
    B --> G
    D --> H
    E --> H
    F --> L
    F --> M
    F --> N
    H --> I
    H --> J
    H --> K
    L --> O
    M --> P
    N --> Q
    I --> R
    J --> S
```

### æ’ä»¶æ ¸å¿ƒç»„ä»¶

#### 1. æ’ä»¶ç®¡ç†å™¨ (PluginManager)
- **æ’ä»¶å‘ç°** - è‡ªåŠ¨æ‰«æå’Œå‘ç°æ’ä»¶
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†** - åŠ è½½ã€åˆå§‹åŒ–ã€å¯åŠ¨ã€åœæ­¢ã€å¸è½½
- **å¥åº·ç›‘æ§** - å®šæœŸå¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡æ”¶é›†
- **é…ç½®ç®¡ç†** - æ’ä»¶é…ç½®çš„åŠ è½½å’Œæ›´æ–°

#### 2. ç»Ÿä¸€æ’ä»¶ç½‘å…³
- **è·¯ç”±è½¬å‘** - è¯·æ±‚è·¯ç”±åˆ°å¯¹åº”æ’ä»¶
- **è´Ÿè½½å‡è¡¡** - å¤šå®ä¾‹æ’ä»¶è´Ÿè½½å‡è¡¡
- **åè®®é€‚é…** - ç»Ÿä¸€æ’ä»¶è°ƒç”¨åè®®
- **å®‰å…¨ä»£ç†** - æ’ä»¶è®¿é—®æ§åˆ¶å’Œæƒé™ç®¡ç†

#### 3. æ’ä»¶SDK
```go
// åŸºç¡€æ’ä»¶æ¥å£
type BasePlugin interface {
    Initialize(ctx context.Context, config *InitializeConfig) error
    Shutdown(ctx context.Context) error
    HealthCheck(ctx context.Context) (*HealthStatus, error)
    GetMetrics(ctx context.Context) (*Metrics, error)
    GetInfo() *PluginInfo
    Logger() hclog.Logger
}

// ç®€åŒ–æ’ä»¶æ¥å£
type SimplePlugin interface {
    Initialize(ctx context.Context, config *InitializeConfig) error
    Shutdown(ctx context.Context) error
    HealthCheck(ctx context.Context) *HealthStatus
    CallTool(ctx context.Context, req *CallToolRequest) *CallToolResponse
    ListTools(ctx context.Context) *ListToolsResponse
    GetToolSchema(ctx context.Context, req *GetToolSchemaRequest) *GetToolSchemaResponse
}
```

### æ’ä»¶ç±»å‹

#### 1. LLMæ’ä»¶
- **åŠŸèƒ½** - å¤§è¯­è¨€æ¨¡å‹é›†æˆ
- **æ”¯æŒ** - OpenAIã€Anthropicã€Azureã€æœ¬åœ°LLM
- **ç‰¹æ€§** - æµå¼è¾“å‡ºã€å‡½æ•°è°ƒç”¨ã€å†…å®¹è¿‡æ»¤

#### 2. ASRæ’ä»¶
- **åŠŸèƒ½** - è¯­éŸ³è¯†åˆ«
- **æ”¯æŒ** - è±†åŒ…ã€ç§‘å¤§è®¯é£ã€Google Speech
- **ç‰¹æ€§** - å®æ—¶è¯†åˆ«ã€å¤šè¯­è¨€æ”¯æŒ

#### 3. TTSæ’ä»¶
- **åŠŸèƒ½** - è¯­éŸ³åˆæˆ
- **æ”¯æŒ** - EdgeTTSã€è±†åŒ…ã€Azure TTS
- **ç‰¹æ€§** - å¤šéŸ³è‰²ã€æƒ…æ„Ÿåˆæˆã€éŸ³é¢‘æµ

#### 4. è®¾å¤‡æ’ä»¶
- **åŠŸèƒ½** - ç¡¬ä»¶è®¾å¤‡æ§åˆ¶
- **æ”¯æŒ** - ESP32ã€Arduinoã€IoTè®¾å¤‡
- **ç‰¹æ€§** - OTAæ›´æ–°ã€çŠ¶æ€ç›‘æ§

### æ’ä»¶å®‰å…¨æœºåˆ¶

#### å¤šçº§æ²™ç®±è®¾è®¡
```yaml
security:
  sandbox:
    enabled: true
    type: docker  # docker, gvisor, none
  permissions:
    default: "restricted"
    plugin_policies:
      - name: "hello-plugin"
        permissions: ["execute", "network_outbound"]
```

#### å®‰å…¨ç‰¹æ€§
- **è¿›ç¨‹éš”ç¦»** - æ’ä»¶ç‹¬ç«‹è¿›ç¨‹è¿è¡Œ
- **å®¹å™¨éš”ç¦»** - Dockerå®¹å™¨å®Œæ•´éš”ç¦»
- **èµ„æºé™åˆ¶** - CPUã€å†…å­˜ã€ç½‘ç»œé™åˆ¶
- **æƒé™æ§åˆ¶** - ç»†ç²’åº¦æƒé™ç®¡ç†
- **ç­¾åéªŒè¯** - æ’ä»¶å®Œæ•´æ€§éªŒè¯

---

## ğŸ“Š æ•°æ®æµæ¶æ„

### æ•°æ®æµå‘å›¾

```mermaid
graph LR
    subgraph "å®¢æˆ·ç«¯å±‚"
        A[Webå®¢æˆ·ç«¯]
        B[ç§»åŠ¨ç«¯App]
        C[ESP32è®¾å¤‡]
    end

    subgraph "APIç½‘å…³å±‚"
        D[Gateway API Server<br/>Port:8090]
    end

    subgraph "æœåŠ¡å±‚"
        E[HTTPæœåŠ¡<br/>Port:8080]
        F[WebSocketæœåŠ¡]
        G[æ’ä»¶ç½‘å…³]
    end

    subgraph "ä¸šåŠ¡é€»è¾‘å±‚"
        H[è®¤è¯æœåŠ¡]
        I[MCPç®¡ç†å™¨]
        J[è®¾å¤‡ç®¡ç†]
        K[æ’ä»¶ç®¡ç†å™¨]
    end

    subgraph "æ’ä»¶å®ä¾‹"
        L[LLMæ’ä»¶]
        M[ASRæ’ä»¶]
        N[TTSæ’ä»¶]
        O[å·¥å…·æ’ä»¶]
    end

    subgraph "æ•°æ®å­˜å‚¨å±‚"
        P[SQLiteæ•°æ®åº“]
        Q[æ–‡ä»¶å­˜å‚¨]
        R[Redisç¼“å­˜]
    end

    A --> D
    B --> D
    C --> D
    D --> E
    D --> F
    E --> H
    E --> I
    E --> J
    F --> I
    G --> K
    K --> L
    K --> M
    K --> N
    K --> O
    H --> P
    I --> P
    J --> P
    K --> P
    I --> Q
    J --> Q
    H --> R
```

### å…¸å‹æ•°æ®æµ

#### 1. ç”¨æˆ·è®¤è¯æµç¨‹
```
å®¢æˆ·ç«¯ â†’ ç½‘å…³ â†’ HTTPæœåŠ¡ â†’ è®¤è¯æœåŠ¡ â†’ æ•°æ®åº“ â†’ è¿”å›Token
```

#### 2. è¯­éŸ³äº¤äº’æµç¨‹
```
å®¢æˆ·ç«¯ â†’ WebSocket â†’ MCPç®¡ç†å™¨ â†’ ASRæ’ä»¶ â†’ LLMæ’ä»¶ â†’ TTSæ’ä»¶ â†’ è¿”å›éŸ³é¢‘
```

#### 3. è®¾å¤‡ç®¡ç†æµç¨‹
```
è®¾å¤‡ â†’ ç½‘å…³ â†’ HTTPæœåŠ¡ â†’ è®¾å¤‡ç®¡ç†å™¨ â†’ æ•°æ®åº“ â†’ OTAæœåŠ¡ â†’ è®¾å¤‡
```

#### 4. æ’ä»¶è°ƒç”¨æµç¨‹
```
å®¢æˆ·ç«¯ â†’ ç½‘å…³ â†’ æ’ä»¶ç½‘å…³ â†’ æ’ä»¶ç®¡ç†å™¨ â†’ å…·ä½“æ’ä»¶ â†’ è¿”å›ç»“æœ
```

---

## ğŸ” å¯è§‚æµ‹æ€§æ¶æ„

### æ—¥å¿—ç³»ç»Ÿ

#### ç»“æ„åŒ–æ—¥å¿—
```go
// æ—¥å¿—æ ¼å¼ç¤ºä¾‹
{
  "timestamp": "2024-01-01T12:00:00Z",
  "level": "INFO",
  "component": "auth",
  "message": "ç”¨æˆ·è®¤è¯æˆåŠŸ",
  "user_id": "12345",
  "client_id": "web-client",
  "duration": "150ms"
}
```

#### æ—¥å¿—åˆ†ç±»
- **ä¸šåŠ¡æ—¥å¿—** - ç”¨æˆ·æ“ä½œã€ä¸šåŠ¡æµç¨‹
- **ç³»ç»Ÿæ—¥å¿—** - æœåŠ¡å¯åŠ¨ã€é…ç½®å˜æ›´
- **é”™è¯¯æ—¥å¿—** - å¼‚å¸¸å¤„ç†ã€é”™è¯¯æ¢å¤
- **å®¡è®¡æ—¥å¿—** - å®‰å…¨äº‹ä»¶ã€æƒé™å˜æ›´

### ç›‘æ§æŒ‡æ ‡

#### ç³»ç»ŸæŒ‡æ ‡
- **CPUä½¿ç”¨ç‡** - ç³»ç»Ÿå’Œè¿›ç¨‹CPUå ç”¨
- **å†…å­˜ä½¿ç”¨é‡** - å†…å­˜å ç”¨å’ŒGCæƒ…å†µ
- **ç½‘ç»œI/O** - ç½‘ç»œååé‡å’Œè¿æ¥æ•°
- **ç£ç›˜I/O** - ç£ç›˜è¯»å†™æ€§èƒ½

#### ä¸šåŠ¡æŒ‡æ ‡
- **è¯·æ±‚é‡** - APIè°ƒç”¨æ¬¡æ•°å’ŒQPS
- **å“åº”æ—¶é—´** - æ¥å£å“åº”å»¶è¿Ÿåˆ†å¸ƒ
- **é”™è¯¯ç‡** - æ¥å£é”™è¯¯ç‡å’Œå¼‚å¸¸ç»Ÿè®¡
- **ç”¨æˆ·æ´»è·ƒåº¦** - åœ¨çº¿ç”¨æˆ·æ•°å’Œä¼šè¯ç»Ÿè®¡

#### æ’ä»¶æŒ‡æ ‡
- **æ’ä»¶çŠ¶æ€** - è¿è¡ŒçŠ¶æ€å’Œå¥åº·æ£€æŸ¥
- **è°ƒç”¨æ¬¡æ•°** - æ’ä»¶å·¥å…·è°ƒç”¨ç»Ÿè®¡
- **æ€§èƒ½æŒ‡æ ‡** - æ’ä»¶æ‰§è¡Œæ—¶é—´å’Œèµ„æºæ¶ˆè€—

### åˆ†å¸ƒå¼è¿½è¸ª

#### è¿½è¸ªæ¶æ„
```mermaid
graph LR
    A[å®¢æˆ·ç«¯è¯·æ±‚] --> B[ç½‘å…³å±‚]
    B --> C[HTTPæœåŠ¡]
    C --> D[ä¸šåŠ¡é€»è¾‘]
    D --> E[æ’ä»¶è°ƒç”¨]
    E --> F[å¤–éƒ¨æœåŠ¡]

    B --> G[è¿½è¸ªæ”¶é›†å™¨]
    C --> G
    D --> G
    E --> G
    F --> G
    G --> H[è¿½è¸ªå­˜å‚¨]
    G --> I[è¿½è¸ªæŸ¥è¯¢]
```

#### è¿½è¸ªä¿¡æ¯
- **è¯·æ±‚é“¾è·¯** - å®Œæ•´çš„è¯·æ±‚è°ƒç”¨é“¾
- **æ€§èƒ½åˆ†æ** - å„é˜¶æ®µè€—æ—¶ç»Ÿè®¡
- **é”™è¯¯å®šä½** - å¼‚å¸¸å‘ç”Ÿçš„ç²¾ç¡®ä½ç½®
- **ä¾èµ–å…³ç³»** - æœåŠ¡é—´ä¾èµ–å…³ç³»å›¾

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### éƒ¨ç½²æ¨¡å¼

#### 1. å•æœºéƒ¨ç½²
```yaml
# docker-compose.yml
version: '3.8'
services:
  xiaozhi-flow:
    build: .
    ports:
      - "8080:8080"
      - "8090:8090"
    volumes:
      - ./data:/app/data
      - ./config:/app/config
    environment:
      - LOG_LEVEL=info
      - DB_PATH=/app/data/xiaozhi.db
```

#### 2. åˆ†å¸ƒå¼éƒ¨ç½²
```yaml
# Kuberneteséƒ¨ç½²
apiVersion: apps/v1
kind: Deployment
metadata:
  name: xiaozhi-flow
spec:
  replicas: 3
  selector:
    matchLabels:
      app: xiaozhi-flow
  template:
    metadata:
      labels:
        app: xiaozhi-flow
    spec:
      containers:
      - name: xiaozhi-flow
        image: xiaozhi-flow:latest
        ports:
        - containerPort: 8080
        - containerPort: 8090
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
```

### ç¯å¢ƒé…ç½®

#### å¼€å‘ç¯å¢ƒ
- **çƒ­é‡è½½** - Airå·¥å…·æ”¯æŒä»£ç çƒ­é‡è½½
- **è°ƒè¯•æ¨¡å¼** - å¼€å¯è¯¦ç»†æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯
- **æ¨¡æ‹Ÿæ•°æ®** - æ”¯æŒMockæ•°æ®å’Œæµ‹è¯•æ’ä»¶

#### ç”Ÿäº§ç¯å¢ƒ
- **æ€§èƒ½ä¼˜åŒ–** - ç”Ÿäº§çº§æ€§èƒ½è°ƒä¼˜
- **å®‰å…¨åŠ å›º** - å¯ç”¨æ‰€æœ‰å®‰å…¨ç‰¹æ€§
- **ç›‘æ§å‘Šè­¦** - å®Œæ•´çš„ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ
- **å¤‡ä»½æ¢å¤** - æ•°æ®å¤‡ä»½å’Œç¾éš¾æ¢å¤

---

## ğŸ”’ å®‰å…¨æ¶æ„

### å¤šå±‚å®‰å…¨é˜²æŠ¤

#### 1. ç½‘ç»œå±‚å®‰å…¨
- **TLS/SSLåŠ å¯†** - HTTPS/WSSé€šä¿¡åŠ å¯†
- **é˜²ç«å¢™è§„åˆ™** - ç«¯å£å’ŒIPè®¿é—®æ§åˆ¶
- **DDoSé˜²æŠ¤** - æµé‡æ¸…æ´—å’Œæ”»å‡»é˜²æŠ¤

#### 2. åº”ç”¨å±‚å®‰å…¨
- **èº«ä»½è®¤è¯** - JWTä»¤ç‰Œè®¤è¯
- **æƒé™æ§åˆ¶** - RBACè§’è‰²æƒé™ç®¡ç†
- **APIé™æµ** - è¯·æ±‚é¢‘ç‡é™åˆ¶
- **è¾“å…¥éªŒè¯** - å‚æ•°æ ¡éªŒå’ŒSQLæ³¨å…¥é˜²æŠ¤

#### 3. æ’ä»¶å®‰å…¨
- **æ²™ç®±éš”ç¦»** - æ’ä»¶è¿è¡Œç¯å¢ƒéš”ç¦»
- **æƒé™æœ€å°åŒ–** - æ’ä»¶åªè·å¾—å¿…è¦æƒé™
- **èµ„æºé™åˆ¶** - CPUã€å†…å­˜ã€ç½‘ç»œé™åˆ¶
- **ç­¾åéªŒè¯** - æ’ä»¶å®Œæ•´æ€§éªŒè¯

#### 4. æ•°æ®å®‰å…¨
- **æ•°æ®åŠ å¯†** - æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- **è®¿é—®å®¡è®¡** - æ•°æ®è®¿é—®æ—¥å¿—è®°å½•
- **å¤‡ä»½åŠ å¯†** - æ•°æ®å¤‡ä»½åŠ å¯†ä¿æŠ¤
- **éšç§ä¿æŠ¤** - ç”¨æˆ·éšç§æ•°æ®è„±æ•

### å®‰å…¨æœ€ä½³å®è·µ

#### è®¤è¯æˆæƒ
```go
// JWTä¸­é—´ä»¶ç¤ºä¾‹
func AuthMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        token := c.GetHeader("Authorization")
        if token == "" {
            c.JSON(401, gin.H{"error": "Missing token"})
            c.Abort()
            return
        }

        claims, err := validateToken(token)
        if err != nil {
            c.JSON(401, gin.H{"error": "Invalid token"})
            c.Abort()
            return
        }

        c.Set("user_id", claims.UserID)
        c.Next()
    }
}
```

#### æ’ä»¶æ²™ç®±
```yaml
# Dockeræ²™ç®±é…ç½®
security:
  sandbox:
    enabled: true
    type: docker
    config:
      network: "none"  # ç¦ç”¨ç½‘ç»œè®¿é—®
      readonly_rootfs: true  # åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
      user: "nobody"  # éç‰¹æƒç”¨æˆ·
      capabilities:
        drop: ["ALL"]  # ç¦ç”¨æ‰€æœ‰èƒ½åŠ›
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç³»ç»Ÿæ€§èƒ½

#### æ•°æ®åº“ä¼˜åŒ–
- **è¿æ¥æ± ç®¡ç†** - ä¼˜åŒ–æ•°æ®åº“è¿æ¥æ•°
- **ç´¢å¼•ç­–ç•¥** - åˆç†è®¾è®¡æ•°æ®åº“ç´¢å¼•
- **æŸ¥è¯¢ä¼˜åŒ–** - SQLæŸ¥è¯¢æ€§èƒ½è°ƒä¼˜
- **ç¼“å­˜ç­–ç•¥** - Redisç¼“å­˜çƒ­ç‚¹æ•°æ®

#### å¹¶å‘å¤„ç†
- **Goroutineæ± ** - åç¨‹æ± ç®¡ç†
- **Channelé€šä¿¡** - é«˜æ•ˆçš„åç¨‹é—´é€šä¿¡
- **é”ä¼˜åŒ–** - å‡å°‘é”ç«äº‰
- **å¼‚æ­¥å¤„ç†** - éé˜»å¡å¼‚æ­¥æ“ä½œ

#### å†…å­˜ç®¡ç†
- **å¯¹è±¡æ± ** - å¤ç”¨é¢‘ç¹åˆ›å»ºçš„å¯¹è±¡
- **å†…å­˜ç¼“å­˜** - åˆç†ä½¿ç”¨å†…å­˜ç¼“å­˜
- **GCè°ƒä¼˜** - åƒåœ¾å›æ”¶å‚æ•°ä¼˜åŒ–
- **å†…å­˜ç›‘æ§** - å®æ—¶å†…å­˜ä½¿ç”¨ç›‘æ§

### æ’ä»¶æ€§èƒ½

#### æ’ä»¶è°ƒç”¨ä¼˜åŒ–
- **è¿æ¥å¤ç”¨** - å¤ç”¨æ’ä»¶è¿æ¥
- **æ‰¹é‡è°ƒç”¨** - æ”¯æŒæ‰¹é‡å·¥å…·è°ƒç”¨
- **ç»“æœç¼“å­˜** - ç¼“å­˜æ’ä»¶è°ƒç”¨ç»“æœ
- **è¶…æ—¶æ§åˆ¶** - åˆç†è®¾ç½®è°ƒç”¨è¶…æ—¶

#### èµ„æºéš”ç¦»
- **CPUé™åˆ¶** - é™åˆ¶æ’ä»¶CPUä½¿ç”¨
- **å†…å­˜é™åˆ¶** - é™åˆ¶æ’ä»¶å†…å­˜å ç”¨
- **ç½‘ç»œé™æµ** - é™åˆ¶æ’ä»¶ç½‘ç»œè®¿é—®
- **ç£ç›˜é…é¢** - é™åˆ¶æ’ä»¶ç£ç›˜ä½¿ç”¨

---

## ğŸ”„ è¿ç»´ç®¡ç†

### é…ç½®ç®¡ç†

#### é…ç½®å±‚æ¬¡
```yaml
# å…¨å±€é…ç½®
global:
  log_level: info
  max_connections: 1000

# æœåŠ¡é…ç½®
services:
  http:
    port: 8080
    timeout: 30s
  websocket:
    port: 8081
    ping_interval: 30s

# æ’ä»¶é…ç½®
plugins:
  enabled: true
  scan_paths:
    - "./plugins"
    - "/opt/xiaozhi-flow/plugins"
```

#### çƒ­æ›´æ–°æ”¯æŒ
- **é…ç½®ç›‘å¬** - ç›‘å¬é…ç½®æ–‡ä»¶å˜æ›´
- **åŠ¨æ€åŠ è½½** - æ— éœ€é‡å¯åŠ è½½æ–°é…ç½®
- **é…ç½®éªŒè¯** - é…ç½®æ–‡ä»¶æ ¼å¼éªŒè¯
- **å›æ»šæœºåˆ¶** - é…ç½®é”™è¯¯è‡ªåŠ¨å›æ»š

### ç›‘æ§å‘Šè­¦

#### ç›‘æ§æŒ‡æ ‡
- **æœåŠ¡å¯ç”¨æ€§** - æœåŠ¡å¥åº·çŠ¶æ€
- **æ€§èƒ½æŒ‡æ ‡** - å“åº”æ—¶é—´ã€ååé‡
- **èµ„æºä½¿ç”¨** - CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
- **ä¸šåŠ¡æŒ‡æ ‡** - ç”¨æˆ·æ´»è·ƒåº¦ã€åŠŸèƒ½ä½¿ç”¨ç‡

#### å‘Šè­¦è§„åˆ™
```yaml
alerts:
  - name: "HighCPUUsage"
    condition: "cpu_usage > 80"
    duration: "5m"
    severity: "warning"

  - name: "ServiceDown"
    condition: "service_status == 'down'"
    duration: "1m"
    severity: "critical"
```

### æ—¥å¿—ç®¡ç†

#### æ—¥å¿—æ”¶é›†
- **ç»Ÿä¸€æ—¥å¿—æ ¼å¼** - ç»“æ„åŒ–JSONæ—¥å¿—
- **æ—¥å¿—èšåˆ** - å¤šæœåŠ¡æ—¥å¿—é›†ä¸­æ”¶é›†
- **æ—¥å¿—è½®è½¬** - æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨è½®è½¬
- **é•¿æœŸå­˜å‚¨** - æ—¥å¿—é•¿æœŸä¿å­˜ç­–ç•¥

#### æ—¥å¿—åˆ†æ
- **å®æ—¶åˆ†æ** - å®æ—¶æ—¥å¿—æµåˆ†æ
- **å¼‚å¸¸æ£€æµ‹** - è‡ªåŠ¨å¼‚å¸¸æ—¥å¿—è¯†åˆ«
- **è¶‹åŠ¿åˆ†æ** - æ—¥å¿—è¶‹åŠ¿ç»Ÿè®¡åˆ†æ
- **æœç´¢æŸ¥è¯¢** - å¼ºå¤§çš„æ—¥å¿—æœç´¢åŠŸèƒ½

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•æ¶æ„

#### å•å…ƒæµ‹è¯•
- **ä¸šåŠ¡é€»è¾‘æµ‹è¯•** - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å•å…ƒæµ‹è¯•
- **å·¥å…·å‡½æ•°æµ‹è¯•** - å·¥å…·å‡½æ•°å’Œå¸®åŠ©æ–¹æ³•æµ‹è¯•
- **æ¥å£æµ‹è¯•** - æ¥å£å®šä¹‰å’Œè¡Œä¸ºæµ‹è¯•
- **Mockæµ‹è¯•** - å¤–éƒ¨ä¾èµ–Mockæµ‹è¯•

#### é›†æˆæµ‹è¯•
- **APIé›†æˆæµ‹è¯•** - APIæ¥å£é›†æˆæµ‹è¯•
- **æ•°æ®åº“é›†æˆæµ‹è¯•** - æ•°æ®åº“æ“ä½œé›†æˆæµ‹è¯•
- **æ’ä»¶é›†æˆæµ‹è¯•** - æ’ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•
- **ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆæµ‹è¯•** - å¤–éƒ¨æœåŠ¡é›†æˆæµ‹è¯•

#### ç«¯åˆ°ç«¯æµ‹è¯•
- **ç”¨æˆ·æµç¨‹æµ‹è¯•** - å®Œæ•´ç”¨æˆ·æ“ä½œæµç¨‹æµ‹è¯•
- **æ€§èƒ½æµ‹è¯•** - ç³»ç»Ÿæ€§èƒ½å’Œè´Ÿè½½æµ‹è¯•
- **å®‰å…¨æµ‹è¯•** - å®‰å…¨æ¼æ´å’Œæ¸—é€æµ‹è¯•
- **å…¼å®¹æ€§æµ‹è¯•** - å¤šå¹³å°å…¼å®¹æ€§æµ‹è¯•

### æµ‹è¯•å·¥å…·

#### æµ‹è¯•æ¡†æ¶
```go
// Goæµ‹è¯•ç¤ºä¾‹
func TestAuthManager(t *testing.T) {
    tests := []struct {
        name     string
        username string
        password string
        wantErr  bool
    }{
        {"valid user", "admin", "password", false},
        {"invalid user", "invalid", "wrong", true},
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            auth := NewAuthManager(config)
            _, err := auth.Authenticate(context.Background(), tt.username, tt.password)
            if (err != nil) != tt.wantErr {
                t.Errorf("Authenticate() error = %v, wantErr %v", err, tt.wantErr)
            }
        })
    }
}
```

#### è‡ªåŠ¨åŒ–æµ‹è¯•
- **CI/CDé›†æˆ** - æŒç»­é›†æˆè‡ªåŠ¨æµ‹è¯•
- **æµ‹è¯•è¦†ç›–ç‡** - ä»£ç è¦†ç›–ç‡ç»Ÿè®¡
- **æ€§èƒ½åŸºå‡†æµ‹è¯•** - æ€§èƒ½åŸºå‡†å¯¹æ¯”
- **å›å½’æµ‹è¯•** - è‡ªåŠ¨å›å½’æµ‹è¯•å¥—ä»¶

---

## ğŸ“š å¼€å‘æŒ‡å—

### å¼€å‘ç¯å¢ƒæ­å»º

#### ç¯å¢ƒè¦æ±‚
- **Go 1.24+** - åç«¯å¼€å‘è¯­è¨€
- **Node.js 18+** - å‰ç«¯å¼€å‘ç¯å¢ƒ
- **Docker** - å®¹å™¨åŒ–å¼€å‘ç¯å¢ƒ
- **Git** - ç‰ˆæœ¬æ§åˆ¶å·¥å…·

#### å¿«é€Ÿå¼€å§‹
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-org/xiaozhi-flow.git
cd xiaozhi-flow

# å®‰è£…åç«¯ä¾èµ–
go mod download

# å®‰è£…å‰ç«¯ä¾èµ–
cd web
npm install

# å¯åŠ¨å¼€å‘ç¯å¢ƒ
cd ..
make dev  # å¯åŠ¨åç«¯çƒ­é‡è½½
cd web && npm run dev  # å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
```

### æ’ä»¶å¼€å‘

#### æ’ä»¶å¼€å‘æ¨¡æ¿
```go
package main

import (
    "context"
    "github.com/hashicorp/go-hclog"
    "xiaozhi-server-go/internal/plugin/sdk"
)

type MyPlugin struct {
    sdk.BasePluginImpl
    logger hclog.Logger
}

func (p *MyPlugin) CallTool(ctx context.Context, req *pluginv1.CallToolRequest) (*pluginv1.CallToolResponse, error) {
    switch req.ToolName {
    case "my_tool":
        return p.myTool(ctx, req.Arguments.AsMap())
    default:
        return nil, fmt.Errorf("unknown tool: %s", req.ToolName)
    }
}

func main() {
    plugin := &MyPlugin{}
    sdk.Serve(plugin)
}
```

#### æ’ä»¶é…ç½®æ–‡ä»¶
```yaml
# plugin.yaml
name: My Plugin
version: 1.0.0
description: My custom plugin
type: utility
capabilities:
  - my_tool
deployment:
  type: local_binary
  path: ./main.go
  resources:
    max_memory: "256Mi"
    max_cpu: "200m"
```

### ä»£ç è§„èŒƒ

#### Goä»£ç è§„èŒƒ
- **gofmt** - ä»£ç æ ¼å¼åŒ–
- **golint** - ä»£ç é£æ ¼æ£€æŸ¥
- **go vet** - é™æ€ä»£ç åˆ†æ
- **gosec** - å®‰å…¨æ¼æ´æ£€æŸ¥

#### TypeScriptä»£ç è§„èŒƒ
- **ESLint** - ä»£ç è´¨é‡æ£€æŸ¥
- **Prettier** - ä»£ç æ ¼å¼åŒ–
- **TypeScript** - ç±»å‹æ£€æŸ¥
- **Husky** - Gité’©å­æ£€æŸ¥

---

## ğŸ”® æœªæ¥è§„åˆ’

### çŸ­æœŸç›®æ ‡ (3-6ä¸ªæœˆ)

#### åŠŸèƒ½å¢å¼º
- **æ’ä»¶å¸‚åœº** - å®˜æ–¹æ’ä»¶å¸‚åœºå’Œåˆ†å‘æœºåˆ¶
- **å¯è§†åŒ–é…ç½®** - å›¾å½¢åŒ–é…ç½®ç®¡ç†ç•Œé¢
- **å¤šç§Ÿæˆ·æ”¯æŒ** - ä¼ä¸šçº§å¤šç§Ÿæˆ·æ¶æ„
- **æ€§èƒ½ä¼˜åŒ–** - è¿›ä¸€æ­¥æ€§èƒ½è°ƒä¼˜å’Œä¼˜åŒ–

#### å¼€å‘ä½“éªŒ
- **CLIå·¥å…·** - å‘½ä»¤è¡Œå¼€å‘å·¥å…·
- **SDKå¢å¼º** - æ›´ä¸°å¯Œçš„æ’ä»¶SDKåŠŸèƒ½
- **æ–‡æ¡£å®Œå–„** - å®Œæ•´çš„å¼€å‘æ–‡æ¡£å’Œæ•™ç¨‹
- **ç¤ºä¾‹é¡¹ç›®** - æ›´å¤šæ’ä»¶ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

### ä¸­æœŸç›®æ ‡ (6-12ä¸ªæœˆ)

#### æ¶æ„æ¼”è¿›
- **å¾®æœåŠ¡åŒ–** - æœåŠ¡è¿›ä¸€æ­¥æ‹†åˆ†å’Œç‹¬ç«‹éƒ¨ç½²
- **äº‹ä»¶é©±åŠ¨** - åŸºäºäº‹ä»¶æµçš„å¼‚æ­¥æ¶æ„
- **äº‘åŸç”Ÿ** - KubernetesåŸç”Ÿéƒ¨ç½²æ”¯æŒ
- **è¾¹ç¼˜è®¡ç®—** - è¾¹ç¼˜è®¾å¤‡éƒ¨ç½²æ”¯æŒ

#### ç”Ÿæ€å»ºè®¾
- **å¼€æºç¤¾åŒº** - å¼€æºç¤¾åŒºå»ºè®¾å’Œè¿è¥
- **åˆä½œä¼™ä¼´** - ç¬¬ä¸‰æ–¹æ’ä»¶å’ŒæœåŠ¡é›†æˆ
- **è®¤è¯ä½“ç³»** - æ’ä»¶è®¤è¯å’Œè´¨é‡ä¿è¯
- **åŸ¹è®­ä½“ç³»** - å¼€å‘è€…åŸ¹è®­å’Œè®¤è¯

### é•¿æœŸæ„¿æ™¯ (1-2å¹´)

#### æŠ€æœ¯åˆ›æ–°
- **AIå¢å¼º** - AIé©±åŠ¨çš„æ™ºèƒ½è¿ç»´å’Œä¼˜åŒ–
- **åŒºå—é“¾** - å»ä¸­å¿ƒåŒ–æ’ä»¶åˆ†å‘å’Œä¿¡ä»»æœºåˆ¶
- **WebAssembly** - WASMæ’ä»¶è¿è¡Œæ—¶æ”¯æŒ
- **ä½ä»£ç ** - ä½ä»£ç æ’ä»¶å¼€å‘å¹³å°

#### å¹³å°åŒ–
- **PaaSå¹³å°** - å¹³å°å³æœåŠ¡èƒ½åŠ›
- **APIç»æµ** - APIå¸‚åœºå’Œå•†ä¸šåŒ–
- **å…¨çƒåŒ–** - å¤šè¯­è¨€å’Œå…¨çƒåŒ–æ”¯æŒ
- **ä¼ä¸šçº§** - å¤§å‹ä¼ä¸šçº§åŠŸèƒ½å’Œç‰¹æ€§

---

## ğŸ“ æ”¯æŒä¸è´¡çŒ®

### è·å–å¸®åŠ©

- **æ–‡æ¡£ä¸­å¿ƒ** - [https://docs.xiaozhi-flow.com](https://docs.xiaozhi-flow.com)
- **APIæ–‡æ¡£** - [https://api.xiaozhi-flow.com](https://api.xiaozhi-flow.com)
- **ç¤¾åŒºè®ºå›** - [https://community.xiaozhi-flow.com](https://community.xiaozhi-flow.com)
- **GitHub Issues** - [https://github.com/your-org/xiaozhi-flow/issues](https://github.com/your-org/xiaozhi-flow/issues)

### è´¡çŒ®æ–¹å¼

#### ä»£ç è´¡çŒ®
1. Forké¡¹ç›®ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. ç¼–å†™ä»£ç å’Œæµ‹è¯•
4. æäº¤Pull Request
5. ä»£ç å®¡æŸ¥å’Œåˆå¹¶

#### æ’ä»¶è´¡çŒ®
1. å¼€å‘ç¬¦åˆè§„èŒƒçš„æ’ä»¶
2. ç¼–å†™è¯¦ç»†æ–‡æ¡£å’Œç¤ºä¾‹
3. æäº¤åˆ°æ’ä»¶å¸‚åœº
4. ç¤¾åŒºåé¦ˆå’Œä¼˜åŒ–

#### æ–‡æ¡£è´¡çŒ®
1. æ”¹è¿›ç°æœ‰æ–‡æ¡£
2. ç¼–å†™æ•™ç¨‹å’Œæœ€ä½³å®è·µ
3. ç¿»è¯‘æ–‡æ¡£åˆ°å¤šè¯­è¨€
4. åˆ†äº«ä½¿ç”¨ç»éªŒ

### è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](LICENSE) å¼€æºè®¸å¯è¯ã€‚

---

## ğŸ“„ æ–‡æ¡£ç‰ˆæœ¬

- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
- **æœ€åæ›´æ–°**: 2024-12-02
- **ç»´æŠ¤å›¢é˜Ÿ**: XiaoZhi Flow å¼€å‘å›¢é˜Ÿ
- **è”ç³»æ–¹å¼**: dev@xiaozhi-flow.com

---

*æœ¬æ–‡æ¡£æŒç»­æ›´æ–°ä¸­ï¼Œå¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤Issueæˆ–PRã€‚*